<!-- index.html for the GUI/Dashboard -->
<!-- Save this as `index.html` inside the `gui/` directory -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crimson.IQ Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Crimson.IQ Simulation Dashboard</h1>
        <div id="pod-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Pod cards will be dynamically added here -->
        </div>
        
        <div id="message-log" class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200 h-64 overflow-y-scroll">
            <h2 class="text-xl font-semibold mb-2 text-gray-700">System Log</h2>
        </div>
    </div>
    
    <!-- FIX: Updated the Paho MQTT library CDN link to a more recent version -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <script>
        // The fix: We use a loop to ensure the Paho library is fully available
        // before we try to use it, preventing a race condition.
        function waitForPaho() {
            if (typeof Paho !== 'undefined') {
                console.log("Paho MQTT library loaded successfully.");
                runSimulation();
            } else {
                console.error("Paho MQTT library not loaded. Trying again in 100ms.");
                setTimeout(waitForPaho, 100);
            }
        }

        // This function contains all the logic for our dashboard.
        function runSimulation() {
            // We use the same host and port as the GUI, and connect to the /mqtt path.
            const mqttHost = "localhost"; 
            const mqttPort = 8080;
            const mqttPath = "/mqtt";

            // Initialize the client with the correct path
            const client = new Paho.MQTT.Client(mqttHost, mqttPort, mqttPath, "dashboard_" + parseInt(Math.random() * 1000, 10));

            let podData = {};

            // Helper to update or create a pod card
            function updatePodCard(pod) {
                let card = document.getElementById(`pod-card-${pod.pod_id}`);
                if (!card) {
                    card = document.createElement('div');
                    card.id = `pod-card-${pod.pod_id}`;
                    card.classList.add('p-6', 'rounded-lg', 'shadow-md', 'transition', 'duration-300', 'ease-in-out', 'transform', 'hover:scale-105', 'bg-gradient-to-br', 'from-blue-200', 'to-blue-300');
                    document.getElementById('pod-cards').appendChild(card);
                }
                card.innerHTML = `
                    <h3 class="text-2xl font-bold mb-2 text-blue-800">Pod ${pod.pod_id}</h3>
                    <p class="text-sm text-blue-700 mb-1">Last Updated: ${new Date().toLocaleTimeString()}</p>
                    <div class="mt-4 space-y-2">
                        <p class="flex items-center text-gray-800">
                            <span class="inline-block w-4 h-4 rounded-full bg-blue-500 mr-2"></span>
                            <span class="font-semibold">Inventory:</span> ${pod.inventory} units
                        </p>
                        <p class="flex items-center text-gray-800">
                            <span class="inline-block w-4 h-4 rounded-full bg-blue-500 mr-2"></span>
                            <span class="font-semibold">Temperature:</span> ${pod.temperature}Â°C
                        </p>
                        <p class="flex items-center text-gray-800">
                            <span class="inline-block w-4 h-4 rounded-full bg-blue-500 mr-2"></span>
                            <span class="font-semibold">Predicted Demand:</span> ${pod.demand_prediction} units
                        </p>
                    </div>
                `;
            }

            // Add a message to the log
            function logMessage(message) {
                const log = document.getElementById('message-log');
                const p = document.createElement('p');
                p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                p.classList.add('text-sm', 'text-gray-600', 'font-mono', 'border-b', 'border-gray-200', 'py-1');
                log.prepend(p);
                // Keep the log from getting too long
                while (log.children.length > 50) {
                    log.removeChild(log.lastChild);
                }
            }
            
            client.onConnected = onConnected;
            client.onMessageArrived = onMessageArrived;
            client.onConnectionLost = onConnectionLost;

            // Connect to MQTT
            function connect() {
                console.log("Connecting to MQTT...");
                client.connect({
                    onSuccess: onConnected,
                    onFailure: onConnectionLost,
                    useSSL: false,
                    cleanSession: true
                });
            }
            
            function onConnected() {
                logMessage("Successfully connected to MQTT broker.");
                // Subscribe to all pod status topics
                client.subscribe("pods/+/status");
                logMessage("Subscribed to 'pods/+/status'");
            }

            function onMessageArrived(message) {
                logMessage(`Received message on topic: ${message.destinationName}`);
                if (message.destinationName.startsWith('pods/')) {
                    const data = JSON.parse(message.payloadString);
                    podData[data.pod_id] = data;
                    updatePodCard(data);
                }
            }

            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    logMessage(`Connection lost: ${responseObject.errorMessage}. Reconnecting in 5 seconds...`);
                    setTimeout(connect, 5000);
                }
            }
            
            // Initial connection attempt
            connect();
        }

        // Start the check to see if Paho is loaded.
        waitForPaho();
    </script>
</body>
</html>
